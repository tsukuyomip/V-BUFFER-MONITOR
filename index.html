<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>V-BUFFER Ultra</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1082/1082844.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { padding-top: var(--sat); padding-bottom: var(--sab); -webkit-tap-highlight-color: transparent; }
        .recording-ring { box-shadow: 0 0 30px rgba(239, 68, 68, 0.5); }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">

    <header class="sticky top-0 p-6 flex justify-between items-center bg-slate-950/80 backdrop-blur-lg z-30 border-b border-white/5">
        <div class="flex items-center gap-3">
            <div id="status-icon" class="p-2 bg-slate-800 rounded-2xl transition-all duration-700">
                <i data-lucide="mic-off" class="w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-black tracking-tighter">V-BUFFER <span class="text-blue-500">ULTRA</span></h1>
        </div>
        <div id="timer" class="hidden font-mono font-bold text-red-500 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">
            00:00
        </div>
    </header>

    <main class="px-6 py-8 space-y-8">
        <div class="bg-slate-900/50 backdrop-blur-md rounded-[3rem] p-8 border border-white/5 shadow-2xl">
            <canvas id="waveform" class="w-full h-32 rounded-2xl mb-6"></canvas>
            
            <div class="space-y-3">
                <div class="flex justify-between text-[10px] uppercase font-black text-slate-500 tracking-widest">
                    <span>15-Min Buffer Health</span>
                    <span id="buffer-stat">00:00 / 15:00</span>
                </div>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div id="buffer-progress" class="h-full bg-gradient-to-r from-blue-600 to-blue-400 w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div id="control-panel" class="space-y-4">
            <button id="master-btn" class="w-full py-6 bg-blue-600 rounded-[2.5rem] font-black text-xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3">
                <i data-lucide="power"></i> システム起動
            </button>
            <p class="text-center text-[10px] text-slate-500 font-bold uppercase tracking-tighter">
                ※ PWA版で止まる場合は、Safariのタブで試して。
            </p>
        </div>

        <div id="clip-controls" class="hidden grid grid-cols-3 gap-3">
            <button data-sec="15" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">15s</button>
            <button data-sec="30" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">30s</button>
            <button data-sec="60" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">1m</button>
            <button data-sec="180" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">3m</button>
            <button data-sec="300" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">5m</button>
            <button data-sec="900" class="clip-btn py-5 bg-slate-900 border border-white/5 rounded-3xl font-black text-xs hover:bg-slate-800 active:bg-blue-600 transition-all">15m</button>
        </div>

        <div id="history-container" class="space-y-4 pb-20">
            <div id="history-list" class="space-y-4"></div>
        </div>
    </main>

    <!-- Save Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-2xl flex items-center justify-center p-8 z-50 hidden">
        <div class="bg-slate-900 border border-white/10 rounded-[3.5rem] w-full max-w-sm p-10 shadow-2xl">
            <h3 class="text-2xl font-black mb-1">Captured</h3>
            <p id="clip-info" class="text-slate-400 text-sm mb-6"></p>
            <input id="filename-input" type="text" class="w-full p-5 bg-slate-950 border border-white/10 rounded-3xl mb-8 outline-none text-lg">
            <div class="flex gap-4">
                <button id="cancel-save" class="flex-1 py-5 bg-slate-800 rounded-3xl font-bold">Discard</button>
                <button id="confirm-save" class="flex-1 py-5 bg-blue-600 rounded-3xl font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- Background Audio Hack: Very long silent audio -->
    <audio id="silent-audio" loop preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFRm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAP8=">
    </audio>

    <script>
        const generateWorklet = (sampleRate) => `
            class RecorderWorklet extends AudioWorkletProcessor {
                constructor() {
                    super();
                    this.bufferSize = ${sampleRate * 60 * 15}; 
                    this.buffer = new Int16Array(this.bufferSize);
                    this.writePtr = 0;
                    this.isFull = false;
                    this.port.onmessage = (e) => {
                        if (e.data.type === 'GET_CLIP') {
                            const samples = e.data.sec * ${sampleRate};
                            const actualSamples = Math.min(samples, this.isFull ? this.bufferSize : this.writePtr);
                            const clip = new Int16Array(actualSamples);
                            let ptr = this.writePtr;
                            for (let i = actualSamples - 1; i >= 0; i--) {
                                ptr = (ptr - 1 + this.bufferSize) % this.bufferSize;
                                clip[i] = this.buffer[ptr];
                            }
                            this.port.postMessage({ type: 'CLIP_DATA', data: clip });
                        }
                    };
                }
                process(inputs) {
                    const channel = inputs[0]?.[0];
                    if (channel) {
                        for (let i = 0; i < channel.length; i++) {
                            const s = Math.max(-1, Math.min(1, channel[i]));
                            this.buffer[this.writePtr] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            this.writePtr = (this.writePtr + 1) % this.bufferSize;
                            if (this.writePtr === 0) this.isFull = true;
                        }
                        if (this.writePtr % 2048 === 0) {
                            this.port.postMessage({ type: 'STATUS', ptr: this.writePtr, full: this.isFull });
                        }
                    }
                    return true;
                }
            }
            registerProcessor('recorder-worklet', RecorderWorklet);
        `;

        let audioCtx, workletNode, analyser, startTime;
        let isActive = false;
        let pendingClipData = null;
        let actualSampleRate = 44100;

        const el = {
            masterBtn: document.getElementById('master-btn'),
            statusIcon: document.getElementById('status-icon'),
            timer: document.getElementById('timer'),
            canvas: document.getElementById('waveform'),
            bufferBar: document.getElementById('buffer-progress'),
            bufferStat: document.getElementById('buffer-stat'),
            historyList: document.getElementById('history-list'),
            modal: document.getElementById('modal'),
            input: document.getElementById('filename-input'),
            silentAudio: document.getElementById('silent-audio')
        };

        const ctx = el.canvas.getContext('2d');
        lucide.createIcons();

        // Resume AudioContext on visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && audioCtx) {
                if (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted') {
                    audioCtx.resume();
                }
            }
        });

        async function initSystem() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                actualSampleRate = audioCtx.sampleRate;
                const blob = new Blob([generateWorklet(actualSampleRate)], { type: 'application/javascript' });
                await audioCtx.audioWorklet.addModule(URL.createObjectURL(blob));

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: false 
                    } 
                });

                // Start physical audio playback to keep session alive
                el.silentAudio.play().catch(e => console.error("Playback failed", e));

                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                
                workletNode = new AudioWorkletNode(audioCtx, 'recorder-worklet');
                workletNode.port.onmessage = (e) => {
                    if (e.data.type === 'STATUS') updateUI(e.data.ptr, e.data.full);
                    if (e.data.type === 'CLIP_DATA') {
                        pendingClipData = e.data.data;
                        document.getElementById('clip-info').innerText = `過去 ${Math.round(pendingClipData.length/actualSampleRate)}秒 を抽出。`;
                        el.input.value = `Clip_${new Date().toLocaleTimeString().replace(/:/g,'-')}`;
                        el.modal.classList.remove('hidden');
                    }
                };

                source.connect(analyser);
                source.connect(workletNode);
                workletNode.connect(audioCtx.destination);

                isActive = true;
                startTime = Date.now();
                
                el.masterBtn.innerHTML = `<i data-lucide="square" class="fill-current"></i> システム停止`;
                el.masterBtn.className = "w-full py-6 bg-slate-800 rounded-[2.5rem] font-black text-xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 border border-white/10 text-red-500";
                el.timer.classList.remove('hidden');
                document.getElementById('clip-controls').classList.remove('hidden');
                el.statusIcon.classList.replace('bg-slate-800', 'bg-red-600');
                el.statusIcon.classList.add('recording-ring');
                el.statusIcon.innerHTML = `<i data-lucide="mic" class="w-6 h-6 animate-pulse"></i>`;
                
                requestAnimationFrame(drawLoop);
                lucide.createIcons();
            } catch (err) {
                alert("マイク許可が必要です");
            }
        }

        el.masterBtn.onclick = () => {
            if (!isActive) initSystem();
            else location.reload();
        };

        function updateUI(ptr, isFull) {
            const currentSamples = isFull ? (actualSampleRate * 60 * 15) : ptr;
            const sec = Math.floor(currentSamples / actualSampleRate);
            el.bufferBar.style.width = `${(currentSamples / (actualSampleRate * 60 * 15)) * 100}%`;
            el.bufferStat.innerText = `${formatTime(sec)} / 15:00`;
            
            // Recalculate timer based on Date.now() for background catch-up
            const realElapsed = Math.floor((Date.now() - startTime) / 1000);
            el.timer.innerText = formatTime(realElapsed);
        }

        function drawLoop() {
            if (!isActive) return;
            requestAnimationFrame(drawLoop);
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(data);
            ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 5;
            ctx.beginPath();
            const sw = el.canvas.width / data.length;
            for(let i=0; i<data.length; i++) {
                const y = (data[i]/128.0) * el.canvas.height/2;
                if(i===0) ctx.moveTo(i*sw, y); else ctx.lineTo(i*sw, y);
            }
            ctx.stroke();
        }

        function formatTime(s) {
            return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        }

        document.querySelectorAll('.clip-btn').forEach(btn => {
            btn.onclick = () => {
                workletNode.port.postMessage({ type: 'GET_CLIP', sec: parseInt(btn.dataset.sec) });
            };
        });

        document.getElementById('confirm-save').onclick = () => {
            const blob = encodeWAV16(pendingClipData, actualSampleRate);
            const url = URL.createObjectURL(blob);
            addHistory(el.input.value, url, Math.round(pendingClipData.length/actualSampleRate));
            el.modal.classList.add('hidden');
        };

        document.getElementById('cancel-save').onclick = () => el.modal.classList.add('hidden');

        function addHistory(name, url, dur) {
            const item = document.createElement('div');
            item.className = "bg-slate-900/80 backdrop-blur-sm p-6 rounded-[2.5rem] border border-white/5 shadow-xl animate-in slide-in-from-bottom-4 duration-500";
            item.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="font-bold text-blue-400 text-lg">${name}</h4>
                        <p class="text-[10px] text-slate-500 font-black uppercase">${dur}s • ${new Date().toLocaleTimeString()}</p>
                    </div>
                    <button class="text-slate-700 hover:text-red-500 delete-btn"><i data-lucide="trash-2"></i></button>
                </div>
                <div class="flex items-center gap-4">
                    <audio src="${url}" controls class="flex-1 h-10 invert brightness-200 opacity-40"></audio>
                    <a href="${url}" download="${name}.wav" class="p-4 bg-blue-600/10 text-blue-500 rounded-2xl"><i data-lucide="download"></i></a>
                </div>
            `;
            el.historyList.prepend(item);
            lucide.createIcons();
            item.querySelector('.delete-btn').onclick = () => item.remove();
        }

        function encodeWAV16(samples, sr) {
            const buf = new ArrayBuffer(44 + samples.length * 2);
            const v = new DataView(buf);
            const s = (o, s) => { for(let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 32 + samples.length * 2, true);
            s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
            v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, sr, true); v.setUint32(28, sr * 2, true);
            v.setUint16(32, 2, true); v.setUint16(34, 16, true);
            s(36, 'data'); v.setUint32(40, samples.length * 2, true);
            for (let i = 0; i < samples.length; i++) v.setInt16(44 + i * 2, samples[i], true);
            return new Blob([buf], { type: 'audio/wav' });
        }
    </script>
</body>
</html>

